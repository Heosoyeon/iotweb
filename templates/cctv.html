<!DOCTYPE html>
{% load static %}

<html
  lang="en"
  class="light-style layout-menu-fixed"
  dir="ltr"
  data-theme="theme-default"
  data-assets-path="../assets/"
  data-template="vertical-menu-template-free"
>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />

    <title>Smart Home</title>

    <meta name="description" content="" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'img/favicon1.ico' %}" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
      rel="stylesheet"
    />

    <!-- Icons. Uncomment required icon fonts -->
    <link rel="stylesheet" href="{% static 'fonts/boxicons.css' %}" />

    <!-- Core CSS -->
    <link rel="stylesheet" href="{% static 'css/core.css' %}" class="template-customizer-core-css" />
    <link rel="stylesheet" href="{% static 'css/theme-default.css' %}" class="template-customizer-theme-css" />
    <link rel="stylesheet" href="{% static 'css/demo.css' %}" />
    <!-- Vendors CSS -->
    <link rel="stylesheet" href="{% static 'css/perfect-scrollbar.css' %}" />

    <link rel="stylesheet" href="{% static 'css/apex-charts.css' %}" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-notify@0.5.5/dist/simple-notify.min.css" />
<!--    <link rel="stylesheet" href="{% static 'css/modal.css' %}"/>-->
    <script src="https://cdn.jsdelivr.net/npm/simple-notify@0.5.5/dist/simple-notify.min.js"></script>
    <!-- Helpers -->
    <script src="{% static 'js/helpers.js' %}"></script>
    <script src="{% static 'js/config.js' %}"></script>
    <script src="{% static 'js/echarts.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/gh/alpine-collective/alpine-magic-helpers@0.5.x/dist/component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.7.3/dist/alpine.min.js" defer></script>
    <script type="text/javascript" src="{% static 'js/clock.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/btncctvonoff.js' %}">
    </script>
    <script src = "https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js"
            type = "text/javascript"> </script>
    <script src="{% static 'js/mymqtt.js' %}"></script>
    <script src="{% static 'js/rfid_alert.js' %}"></script>
    <script src="https://code.jquery.com/jquery-latest.js"></script>

    <script type="text/javascript">
    var host = "192.168.0.24"
    var port = 9001
    var mqtt;
    var distance = 0;
    function onConnect(){
        console.log("연결완료")
        mqtt.subscribe("iot/#")
    }

    function onMessageArrived(msg){
        topic = msg.destinationName.split('/')
        if(topic[1] == "mycamera"){
          document.getElementById("myimg").src = "data:image/jpeg;base64,"+btoa(String.fromCharCode.apply(null,msg.payloadBytes))
        }else if (topic[1] == "dis"){
          distance = parseInt(msg.payloadString);
          if (distance <= 40){
                alert("보안장치를 먼저 해제해 주세요")
          }
        }else if (topic[1] == "mypet"){
          out_msg = "메시지 전달:"+msg.payloadString;
          content = document.getElementById("mypet");
          content.innerHTML = out_msg;
        }else if (topic[1] == "sound"){
          alert("큰 소리가 감지되었습니다.");
        }
    }
    function onFailure(){
        console.log("연결실패");
        setTimeout(MQTTConnect,reconnectTimeout);
    }
    function sendMsg(msg){
      message = new Paho.MQTT.Message(msg);
      message.destinationName = "camerachk"
      mqtt.send(message);
    }
    function MQTTConnect(){
        mqtt = new Paho.MQTT.Client(host,port,"streaming");
        var options = {
            timeout:3,
            onSuccess : onConnect,
            onFailure : onFailure,
        }
        mqtt.onMessageArrived = onMessageArrived;
        mqtt.connect(options);
    }

    </script>

  </head>

  {% if request.session.sessionid == None %}
  <body>
        <!-- /Logo -->
        <h4 class="d-flex  justify-content-center">로그인 해 주세요</h4>
        <a class ="d-flex  justify-content-center" href ="/">로그인 하러 가기</a>
    <script async defer src="https://buttons.github.io/buttons.js"></script>
  </body>
</html>
{% else %}
<body onload="printClock(); cctvinit();">
<img src="{% static 'img/cctvwait.png' %}" id="myimg" width="100%" height="100%"/><br><br>
<div style="display:flex">
<input class="btn btn-sm btn-outline-primary" type="button" id="cctv" value="CCTV On" onclick="CctvOnOff()">
<div style="margin-left:150px; width:100%; height:15px; color:#666; font-size:20px; text-align:center;" id="clock">
</div>
</div>
<script type="text/javascript">
      MQTTConnect()

  </script>
{% endif %}
</body>